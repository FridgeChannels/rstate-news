# Realtor.com 反爬虫机制分析与解决方案

**分析日期:** 2026-01-28  
**问题类型:** `bug` + `improvement`  
**优先级:** `high`

## 问题现象

### 1. 浏览器意外关闭
- **现象**: 浏览器在访问页面后3-5秒内被意外关闭
- **日志**: `"浏览器进程意外断开（非正常关闭）"`
- **发生时机**: 页面访问后、内容提取前
- **频率**: 几乎每次访问都发生

### 2. 代码错误
- **错误**: `TypeError: can only concatenate str (not "int") to str`
- **位置**: `base_scraper.py:279` 在 `_retry_with_backoff` 方法中
- **原因**: `max_retries` 参数传递问题

### 3. 内容提取失败
- **现象**: 无法找到文章元素（0篇文章）
- **原因**: 浏览器关闭导致无法提取内容

## 反爬虫机制分析

### 检测机制（基于日志和Web研究）

1. **浏览器指纹检测**
   - 检测 `navigator.webdriver` 标志
   - 检测自动化特征（当前已部分处理）
   - 检测headless模式特征

2. **行为模式检测**
   - 检测快速导航（`networkidle`等待策略可能触发）
   - 检测缺少人类行为（无鼠标移动、滚动等）
   - 检测请求频率异常

3. **进程检测**
   - 可能检测到Playwright/Chromium进程特征
   - 检测浏览器启动参数中的自动化标志

4. **网络特征检测**
   - 检测User-Agent一致性
   - 检测请求头特征
   - 可能使用Cloudflare或类似服务

### 当前反检测措施（不足）

**已实现：**
- ✅ 隐藏 `navigator.webdriver`
- ✅ 使用随机User-Agent
- ✅ 添加 `--disable-blink-features=AutomationControlled`
- ✅ 随机延迟

**缺失：**
- ❌ 更完整的浏览器指纹隐藏
- ❌ 人类行为模拟（鼠标移动、滚动）
- ❌ 更真实的等待策略（避免`networkidle`）
- ❌ 更完善的请求头设置
- ❌ 可能的代理轮换

## 解决方案

### 方案1: 增强反检测脚本（推荐）

**实施内容：**
1. **扩展浏览器指纹隐藏**
   - 隐藏更多自动化特征
   - 添加真实的浏览器属性
   - 模拟真实的Chrome环境

2. **改进等待策略**
   - 避免使用`networkidle`（容易被检测）
   - 使用`domcontentloaded` + 固定延迟
   - 添加随机延迟模拟人类行为

3. **添加人类行为模拟**
   - 随机鼠标移动
   - 随机滚动
   - 模拟阅读时间

4. **修复代码错误**
   - 修复`_retry_with_backoff`的参数传递问题

### 方案2: 使用非headless模式

**优势：**
- 更接近真实浏览器
- 减少自动化检测

**劣势：**
- 需要图形界面
- 资源消耗更大

### 方案3: 使用代理服务

**优势：**
- 隐藏真实IP
- 轮换IP避免封禁

**劣势：**
- 需要额外成本
- 配置复杂

### 方案4: 使用专门的stealth库

**选项：**
- `playwright-stealth` (Python)
- `undetected-playwright`
- 自定义更完整的反检测脚本

## 推荐实施步骤

### 优先级1: 修复代码错误
- 修复`_retry_with_backoff`调用问题
- 确保参数正确传递

### 优先级2: 增强反检测脚本
- 扩展`add_init_script`中的反检测代码
- 添加更多浏览器属性隐藏

### 优先级3: 改进等待策略
- 替换`networkidle`为`domcontentloaded`
- 添加固定延迟 + 随机延迟

### 优先级4: 添加行为模拟
- 在页面加载后添加随机滚动
- 模拟鼠标移动（可选）

### 优先级5: 测试和验证
- 测试修复后的效果
- 监控浏览器关闭频率
- 验证内容提取成功率

## 需要确认的问题

1. **是否必须使用headless模式？**
   - 如果可以使用非headless，检测率会降低

2. **是否可以接受更长的等待时间？**
   - 更真实的延迟可以降低检测率，但会增加总时间

3. **是否需要代理服务？**
   - 如果IP被封禁，可能需要代理

4. **错误频率？**
   - 是每次都失败，还是偶尔失败？

5. **其他scraper是否正常？**
   - 如果只有Realtor.com有问题，可能是特定检测机制

## 相关文件

- `scrapers/realtor_scraper.py` - 主要修复文件
- `scrapers/base_scraper.py` - 反检测脚本和浏览器设置
- `scrapers/base_scraper.py:256` - `_retry_with_backoff`方法（需要修复）

## 参考资料

- Playwright反检测最佳实践（2025）
- Realtor.com特定的反爬虫机制
- 其他成功案例的解决方案
